<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yqrb.mapper.ChatMessageMapperCustom">

    <!-- 结果集映射 -->
    <resultMap id="ChatMessageResultMap" type="com.yqrb.pojo.vo.ChatMessageVO">
        <id column="id" property="id"/>
        <result column="msg_id" property="msgId"/>
        <result column="sender_id" property="senderId"/>
        <result column="sender_type" property="senderType"/>
        <result column="receiver_id" property="receiverId"/>
        <result column="content" property="content"/>
        <result column="msg_type" property="msgType"/>
        <result column="session_id" property="sessionId"/>
        <result column="send_time" property="sendTime"/>
        <result column="is_read" property="isRead"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 更新消息已读状态 -->
    <update id="updateMsgReadStatus">
        UPDATE chat_message
        SET is_read = 1,
            update_time = NOW()
        WHERE msg_id = #{msgId}
    </update>

    <!-- 批量查询未读消息 -->
    <select id="selectUnreadMsgByReceiverId" resultMap="ChatMessageResultMap">
        SELECT * FROM chat_message
        WHERE receiver_id = #{receiverId} AND is_read = 0
        ORDER BY send_time ASC
    </select>

    <!-- 新增：按sessionId删除会话所有消息 -->
    <delete id="deleteBySessionId">
        DELETE FROM chat_message WHERE session_id = #{sessionId}
    </delete>

    <update id="batchUpdateMsgReadStatusBySessionId">
        UPDATE chat_message
        SET is_read = 1
        WHERE session_id = #{sessionId}
          AND receiver_id = #{receiverId}
          AND is_read = 0
    </update>

    <select id="selectBySessionId" resultType="com.yqrb.pojo.vo.ChatMessageVO">
        SELECT
            msg_id as msgId,
            sender_id as senderId,
            sender_type as senderType,
            receiver_id as receiverId,
            content as msgContent,
            msg_type as msgType,
            session_id as sessionId,
            send_time as sendTime,
            is_read as isRead,
            create_time as createTime
        FROM chat_message
        WHERE session_id = #{sessionId}
        ORDER BY send_time ASC
            LIMIT #{pageSize} OFFSET #{(pageNum-1)*pageSize}
    </select>
</mapper>