<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yqrb.mapper.ChatMessageMapperCustom">

    <!-- 结果集映射 -->
    <resultMap id="ChatMessageResultMap" type="com.yqrb.pojo.vo.ChatMessageVO">
        <id column="id" property="id"/>
        <result column="msg_id" property="msgId"/>
        <result column="sender_id" property="senderId"/>
        <result column="sender_type" property="senderType"/>
        <result column="receiver_id" property="receiverId"/>
        <result column="content" property="content"/>
        <result column="msg_type" property="msgType"/>
        <result column="session_id" property="sessionId"/>
        <result column="send_time" property="sendTime"/>
        <result column="is_read" property="isRead"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 更新消息已读状态 -->
    <update id="updateMsgReadStatus">
        UPDATE chat_message
        SET is_read = 1,
            update_time = NOW()
        WHERE msg_id = #{msgId}
    </update>

    <!-- 批量查询未读消息 -->
    <select id="selectUnreadMsgByReceiverId" resultMap="ChatMessageResultMap">
        SELECT * FROM chat_message
        WHERE receiver_id = #{receiverId} AND is_read = 0
        ORDER BY send_time ASC
    </select>

    <!-- 新增：按sessionId删除会话所有消息 -->
    <delete id="deleteBySessionId">
        DELETE FROM chat_message WHERE session_id = #{sessionId}
    </delete>

    <update id="batchUpdateMsgReadStatusBySessionId">
        UPDATE chat_message
        SET is_read = 1
        WHERE session_id = #{sessionId}
          AND receiver_id = #{receiverId}
          AND is_read = 0
    </update>

    <!-- 分页查询会话消息：复用 ChatMessageResultMap，保证字段映射正确 -->
    <select id="getMessageListBySessionIdWithPage" resultMap="ChatMessageResultMap">
        SELECT
            id,
            msg_id,
            sender_id,
            sender_type,
            receiver_id,
            content,
            msg_type,
            session_id,
            send_time,
            is_read,
            create_time
        FROM
            chat_message
        WHERE
            session_id = #{sessionId}
          AND receiver_id = #{receiverId}
        ORDER BY
            send_time ASC
    </select>

    <!-- 根据msgId查询单个消息，复用已有的结果集映射 ChatMessageResultMap，避免字段映射错误 -->
    <select id="selectByMsgId" resultMap="ChatMessageResultMap">
        SELECT
            id,
            msg_id,
            sender_id,
            sender_type,
            receiver_id,
            content,
            msg_type,
            session_id,
            send_time,
            is_read,
            create_time,
            update_time
        FROM chat_message
        WHERE msg_id = #{msgId}
    </select>

    <!-- 统计会话下接收者的未读消息条数 -->
    <select id="countUnreadMsgBySessionIdAndReceiverId" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM chat_message
        WHERE session_id = #{sessionId}
          AND receiver_id = #{receiverId}
          AND is_read = 0
    </select>

    <!-- 统计接收者的所有未读消息总数 -->
    <select id="countTotalUnreadMsgByReceiverId" resultType="java.lang.Long">
        SELECT COUNT(*) FROM chat_message
        WHERE receiver_id = #{receiverId}
          AND is_read = 0
    </select>
</mapper>